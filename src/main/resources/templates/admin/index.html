<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{base::layout(~{::section})}">
<head>
    <meta charset="ISO-8859-1">
    <title>Admin Dashboard</title>
    <!-- Bootstrap CSS assumed, and Bootstrap Icons linked: -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            letter-spacing: 0.02em;
        }
        .container.p-5 {
            background: rgba(250, 250, 255, 0.94);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(102,126,234,0.13);
            margin-top: 60px;
            backdrop-filter: blur(4px);
        }
        .text-center.fs-3.mt-4 {
            font-size: 2.9rem !important;
            font-weight: 800;
            letter-spacing: 0.03em;
            color: #574ae2;
            margin-bottom: 30px;
            text-shadow: 2px 2.5px 6px rgba(118,75,162,0.11);
            background: -webkit-linear-gradient(60deg,#667eea,#dbb1ff 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-sh {
            border: none;
            border-radius: 22px;
            background: rgba(247,245,250,0.7);
            box-shadow: 0 4px 28px rgba(118,75,162,0.12);
            position: relative;
            overflow: hidden;
            transition:
                    box-shadow 0.4s,
                    background 0.22s,
                    transform 0.35s cubic-bezier(.23,.67,.23,0.72);
            animation: cardFadeIn 0.8s cubic-bezier(.42,0,.57,1.55) backwards;
        }
        @keyframes cardFadeIn {
            from { transform: translateY(32px) scale(0.88); opacity: 0; }
            to { transform: none; opacity: 1; }
        }
        .card-sh:hover,
        .card-sh:focus-within {
            background: rgba(255,255,255,1);
            box-shadow: 0 12px 55px 0 rgba(117,80,178,0.31);
            transform: scale(1.035) rotateZ(-2deg);
        }
        .card-sh::before {
            content:"";
            position:absolute;
            inset:0;
            border: 4px solid transparent;
            border-radius: 22px;
            pointer-events: none;
            transition: border 0.26s;
        }
        .card-sh:hover::before,
        .card-sh:focus-within::before {
            border-image: linear-gradient(120deg,#667eea 5%, #ffb22e 56%, #31b46f 93%) 1;
        }
        .card-body {
            border-radius: 18px;
            padding: 39px 8px 18px 8px;
        }
        .card-body i, .card-body .bi {
            margin-bottom: 14px;
            font-size: 3.2rem;
            transition: transform 0.43s cubic-bezier(.41,.64,.56,1.39), color 0.23s;
            filter: drop-shadow(0 8px 14px rgba(103,126,234,.21));
        }
        .card-sh:hover .card-body i,
        .card-sh:hover .card-body .bi {
            transform: scale(1.19) rotate(-8deg) skewY(-2deg);
            filter: drop-shadow(0 18px 28px rgba(118,75,162,.23));
        }
        .card-body h4 {
            font-size: 1.23rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            margin-top: 10px;
            color: #333;
            opacity: 0.93;
        }
        .text-primary { color: #667eea !important; }
        .text-warning { color: #ffb22e !important; }
        .text-success { color: #31b46f !important; }
        .text-info { color: #25cfe6 !important; }
        .text-error { color: #ff5561 !important; }

        a.text-decoration-none {
            border-radius: 18px;
            transition: box-shadow 0.14s, transform 0.21s;
        }
        a.text-decoration-none:focus, a.text-decoration-none:hover {
            text-decoration: none;
            outline: none;
            box-shadow: 0 0 0 6px rgba(118,75,162,0.13);
            transform: translateY(-2px) scale(1.012);
        }

        @media (max-width: 991px) {
            .row.p-5 { padding: 12px 2px !important; }
            .card-body { padding: 30px 2px 10px 2px; }
        }
        @media (max-width: 767px) {
            .container.p-5 { padding: 14px 2px !important; }
            .text-center.fs-3.mt-4 { font-size: 2.3rem !important; }
        }

    </style>
</head>
<body>
<section>
    <div class="container p-5">
        <p class="text-center fs-3 mt-4">Admin Dashboard</p>
        <div class="row p-5 justify-content-center">

            <div class="col-md-4 mt-2 mb-3">
                <a href="/admin/loadAddProduct" class="text-decoration-none">
                    <div class="card card-sh h-100">
                        <div class="card-body text-center text-info">
                            <i class="bi bi-bag-plus"></i>
                            <h4>Add Product</h4>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-4 mt-2 mb-3">
                <a href="/admin/category" class="text-decoration-none">
                    <div class="card card-sh h-100">
                        <div class="card-body text-center text-warning">
                            <i class="bi bi-tags"></i>
                            <h4>Add Category</h4>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-4 mt-2 mb-3">
                <a href="/admin/products" class="text-decoration-none">
                    <div class="card card-sh h-100">
                        <div class="card-body text-center text-success">
                            <i class="bi bi-layout-text-sidebar-reverse"></i>
                            <h4>View Product</h4>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-4 mt-4 mb-3">
                <a href="/admin/orders" class="text-decoration-none">
                    <div class="card card-sh h-100">
                        <div class="card-body text-center text-error">
                            <i class="bi bi-box-seam"></i>
                            <h4>Orders</h4>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-4 mt-4 mb-3">
                <a href="/admin/users?type=1" class="text-decoration-none">
                    <div class="card card-sh h-100">
                        <div class="card-body text-center text-primary">
                            <i class="bi bi-people"></i>
                            <h4>Users</h4>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-4 mt-4 mb-3">
                <a href="/admin/add-admin" class="text-decoration-none">
                    <div class="card card-sh h-100">
                        <div class="card-body text-center text-info">
                            <i class="bi bi-person-plus"></i>
                            <h4>Add Admin</h4>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-4 mt-4 mb-3">
                <a href="/admin/users?type=2" class="text-decoration-none">
                    <div class="card card-sh h-100">
                        <div class="card-body text-center text-primary">
                            <i class="bi bi-person-badge"></i>
                            <h4>Admin</h4>
                        </div>
                    </div>
                </a>
            </div>
            <!-- Inline reports charts: Top Products and Top Users -->
            <div class="col-12 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Top products: <span th:text="${topProducts != null} ? ${#lists.size(topProducts)} : 0">0</span></small>
                        &nbsp;&nbsp;
                        <small class="text-muted">Top users: <span th:text="${topUsers != null} ? ${#lists.size(topUsers)} : 0">0</span></small>
                    </div>
                    <div>
                        <small class="text-secondary">(If charts are blank, see JSON below for server-supplied data)</small>
                    </div>
                </div>
                <div class="mt-2">
                    <button id="toggle-debug" class="btn btn-sm btn-outline-secondary">Show debug JSON</button>
                </div>
                <pre id="debug-json" style="display:block; white-space:pre-wrap; word-break:break-word; background:#f8f9fb; padding:8px; border-radius:6px; margin-top:6px; max-height:240px; overflow:auto;" th:utext="${topProductsJson}"></pre>
                <pre id="debug-json-users" style="display:block; white-space:pre-wrap; word-break:break-word; background:#f8f9fb; padding:8px; border-radius:6px; margin-top:6px; max-height:240px; overflow:auto;" th:utext="${topUsersJson}"></pre>
            </div>
            <div class="col-12 mt-4 mb-3">
                <div class="card card-sh">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Top Products (by quantity sold)</h5>
                                <canvas id="topProductsChart" style="width:100%;height:320px;"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h5>Top Users (by total spent)</h5>
                                <canvas id="topUsersChart" style="width:100%;height:320px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
/*<![CDATA[*/
    // Robust loading: first try parsing JSON-string attributes; if parsing fails,
    // fall back to Thymeleaf inlining of the list objects.
    var topProducts;
    var topUsers;
    try {
        topProducts = JSON.parse(/*[[${topProductsJson}]]*/ '[]');
    } catch (e) {
        try { topProducts = /*[[${topProducts}]]*/ []; } catch (e2) { topProducts = []; }
    }
    try {
        topUsers = JSON.parse(/*[[${topUsersJson}]]*/ '[]');
    } catch (e) {
        try { topUsers = /*[[${topUsers}]]*/ []; } catch (e2) { topUsers = []; }
    }

    // Log data for debugging
    try {
        console.log('topProducts (server):', topProducts);
        console.log('topUsers (server):', topUsers);
    } catch (e) {
        console.error('Error logging topProducts/topUsers:', e);
    }

    // Toggle debug JSON visibility and render charts after DOM ready
    document.addEventListener('DOMContentLoaded', function(){
        var btn = document.getElementById('toggle-debug');
        var p1 = document.getElementById('debug-json');
        var p2 = document.getElementById('debug-json-users');
        if(btn) {
            btn.addEventListener('click', function(){
                var show = p1.style.display === 'none';
                p1.style.display = show ? 'block' : 'none';
                p2.style.display = show ? 'block' : 'none';
                btn.textContent = show ? 'Hide debug JSON' : 'Show debug JSON';
            });
        }

        // initial render attempt (after DOM ready so sizes are available)
        renderCharts();

        // If no data was supplied by Thymeleaf, fetch public debug endpoint and re-render
        if ((!topProducts || topProducts.length === 0) && (!topUsers || topUsers.length === 0)) {
            fetch('/debug/reports').then(function(resp){
                if (!resp.ok) throw new Error('Network response was not ok');
                return resp.json();
            }).then(function(json){
                if (json) {
                    topProducts = json.topProducts || [];
                    topUsers = json.topUsers || [];
                    // update debug pre blocks
                    if (p1) p1.textContent = JSON.stringify(topProducts, null, 2);
                    if (p2) p2.textContent = JSON.stringify(topUsers, null, 2);
                    renderCharts();
                }
            }).catch(function(err){
                console.warn('Failed to fetch fallback reports:', err);
            });
        }
    });

    // Map to labels and data with safe fallbacks
    var pLabels = (topProducts || []).map(function(p){ return (p.productTitle && p.productTitle.length>0) ? p.productTitle : ('Product #' + p.productId); });
    var pData = (topProducts || []).map(function(p){ return p.totalQuantity != null ? p.totalQuantity : 0; });

    var uLabels = (topUsers || []).map(function(u){ return (u.userName && u.userName.length>0) ? u.userName : ('User #' + u.userId); });
    var uData = (topUsers || []).map(function(u){ return u.totalSpent != null ? u.totalSpent : 0; });

    // Chart instances will be stored here so we can update them later
    var topProductsChartInstance = null;
    var topUsersChartInstance = null;

    function renderCharts() {
        // compute labels/data from current topProducts/topUsers
        pLabels = (topProducts || []).map(function(p){ return (p.productTitle && p.productTitle.length>0) ? p.productTitle : ('Product #' + p.productId); });
        pData = (topProducts || []).map(function(p){ return p.totalQuantity != null ? p.totalQuantity : 0; });

        uLabels = (topUsers || []).map(function(u){ return (u.userName && u.userName.length>0) ? u.userName : ('User #' + u.userId); });
        uData = (topUsers || []).map(function(u){ return u.totalSpent != null ? u.totalSpent : 0; });

        // Top Products Chart
        (function(){
            try {
                const canvas = document.getElementById('topProductsChart');
                if (!canvas) return;

                // Ensure canvas has proper internal pixel dimensions to avoid blurry/blank charts
                var cssHeight = 320; // we used style height:320px
                canvas.height = cssHeight * (window.devicePixelRatio || 1);
                canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);

                const ctx = canvas.getContext('2d');

                console.log('Rendering TopProducts chart with labels=', pLabels, 'data=', pData);

                if (topProductsChartInstance) {
                    topProductsChartInstance.data.labels = pLabels;
                    topProductsChartInstance.data.datasets[0].data = pData;
                    topProductsChartInstance.update();
                } else {
                    topProductsChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: pLabels,
                            datasets: [{
                                label: 'Quantity Sold',
                                data: pData,
                                backgroundColor: 'rgba(54,162,235,0.7)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }
            } catch (err) {
                console.error('Error rendering TopProducts chart:', err);
            }
        })();

        // Top Users Chart
        (function(){
            try {
                const canvas = document.getElementById('topUsersChart');
                if (!canvas) return;

                var cssHeight = 320;
                canvas.height = cssHeight * (window.devicePixelRatio || 1);
                canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);

                const ctx = canvas.getContext('2d');

                console.log('Rendering TopUsers chart with labels=', uLabels, 'data=', uData);

                if (topUsersChartInstance) {
                    topUsersChartInstance.data.labels = uLabels;
                    topUsersChartInstance.data.datasets[0].data = uData;
                    topUsersChartInstance.update();
                } else {
                    topUsersChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: uLabels,
                            datasets: [{
                                label: 'Total Spent',
                                data: uData,
                                backgroundColor: 'rgba(255,99,132,0.7)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }
            } catch (err) {
                console.error('Error rendering TopUsers chart:', err);
            }
        })();
    }

    // initial render attempt
    renderCharts();

    // If no data was supplied by Thymeleaf, fetch public debug endpoint and re-render
    if ((!topProducts || topProducts.length === 0) && (!topUsers || topUsers.length === 0)) {
        fetch('/debug/reports').then(function(resp){
            if (!resp.ok) throw new Error('Network response was not ok');
            return resp.json();
        }).then(function(json){
            if (json) {
                topProducts = json.topProducts || [];
                topUsers = json.topUsers || [];
                // update debug pre blocks
                var p1 = document.getElementById('debug-json');
                var p2 = document.getElementById('debug-json-users');
                if (p1) p1.textContent = JSON.stringify(topProducts, null, 2);
                if (p2) p2.textContent = JSON.stringify(topUsers, null, 2);
                renderCharts();
            }
        }).catch(function(err){
            console.warn('Failed to fetch fallback reports:', err);
        });
    }
/*]]>*/
</script>

</body>
</html>
