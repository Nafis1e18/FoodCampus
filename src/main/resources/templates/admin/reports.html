<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{base::layout(~{::section})}">
<head>
    <meta charset="ISO-8859-1">
    <title>Reports</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<section>
    <div class="container mt-4">
        <h3 class="text-center">Reports</h3>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5>Top Products (by quantity sold)</h5>
                    <canvas id="topProductsChart" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-3">
                    <h5>Top Users (by total spent)</h5>
                    <canvas id="topUsersChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<script th:inline="javascript">
/*<![CDATA[*/
    const topProducts = /*[[${topProducts}]]*/ [];
    const topUsers = /*[[${topUsers}]]*/ [];

    // prepare product labels and data
    const productLabels = topProducts.map(p => p.productTitle || ('Product #' + p.productId));
    const productData = topProducts.map(p => p.totalQuantity || 0);

    // prepare user labels and data
    const userLabels = topUsers.map(u => u.userName || ('User #' + u.userId));
    const userData = topUsers.map(u => u.totalSpent || 0);

    // Top Products Chart
    const ctxP = document.getElementById('topProductsChart').getContext('2d');
    new Chart(ctxP, {
        type: 'bar',
        data: {
            labels: productLabels,
            datasets: [{
                label: 'Quantity Sold',
                data: productData,
                backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // Top Users Chart
    const ctxU = document.getElementById('topUsersChart').getContext('2d');
    new Chart(ctxU, {
        type: 'bar',
        data: {
            labels: userLabels,
            datasets: [{
                label: 'Total Spent',
                data: userData,
                backgroundColor: 'rgba(255, 99, 132, 0.6)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
/*]]>*/
</script>
</body>
</html>

